# 智能食谱管理系统 - 数据库文档

## 数据库概述

- **数据库类型**: MySQL
- **字符集**: utf8mb4
- **时区**: +08:00 (Asia/Shanghai)
- **ORM框架**: Sequelize

---

## 数据表结构

### 1. users（用户表）

存储系统用户的基本信息。

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 用户唯一标识 |
| username | VARCHAR(50) | NOT NULL | - | 用户名（可重复，可修改，用作昵称） |
| phone | VARCHAR(20) | NOT NULL, UNIQUE | - | 手机号（登录凭证，唯一） |
| password | VARCHAR(100) | NOT NULL | - | 密码（加密存储） |
| nickname | VARCHAR(50) | NULL | - | 用户昵称 |
| created_at | DATETIME | - | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `phone`

**关联关系**:
- 一对一: `fridges` (通过 `user_id`)
- 一对多: `recipes` (通过 `user_id`)
- 一对多: `shopping_items` (通过 `user_id`)
- 一对多: `user_recipes` (通过 `user_id`)

---

### 2. recipes（食谱表）

存储系统食谱和用户创建的食谱。

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 食谱唯一标识 |
| user_id | INTEGER | NULL | - | 创建者ID（NULL表示系统食谱） |
| name | VARCHAR(100) | NOT NULL | - | 食谱名称 |
| category | VARCHAR(20) | NULL | - | 分类（早餐/午餐/晚餐/汤/甜点等） |
| difficulty | VARCHAR(20) | NULL | - | 难度（简单/中等/困难） |
| cooking_time | VARCHAR(20) | NULL | - | 烹饪时间（如"30分钟"） |
| image | VARCHAR(200) | NULL | - | 食谱图片URL |
| ingredients | JSON | NULL | - | 食材列表 `[{"name":"鸡蛋","quantity":"2个"}]` |
| steps | JSON | NULL | - | 烹饪步骤 `["步骤1","步骤2"]` |
| tips | TEXT | NULL | - | 烹饪提示 |
| nutrition | JSON | NULL | - | 营养信息 `{"calories":"200kcal","protein":"10g"}` |
| is_favorite | BOOLEAN | - | false | 是否收藏（仅用于个人食谱） |
| cooked_count | INTEGER | - | 0 | 烹饪次数 |
| created_at | DATETIME | - | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `user_id`
- INDEX: `category`
- INDEX: `is_favorite`
- INDEX: `cooked_count`
- INDEX: `created_at`

**关联关系**:
- 多对一: `users` (通过 `user_id`)
- 一对多: `user_recipes` (通过 `recipe_id`)

**重要说明**:
- `user_id = NULL`: 系统预设食谱
- `user_id != NULL`: 用户创建的食谱
- 系统食谱的收藏状态存储在 `user_recipes` 表
- 个人食谱的收藏状态存储在本表的 `is_favorite` 字段

---

### 3. user_recipes（用户-食谱关联表）

存储用户与系统食谱的关联关系（收藏、添加到个人库）。

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 关联记录唯一标识 |
| user_id | INTEGER | NOT NULL | - | 用户ID |
| recipe_id | INTEGER | NOT NULL | - | 食谱ID（系统食谱） |
| is_favorite | BOOLEAN | - | false | 是否收藏 |
| added_at | DATETIME | - | CURRENT_TIMESTAMP | 添加时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE INDEX: `unique_user_recipe` (`user_id`, `recipe_id`) - 防止重复添加
- INDEX: `idx_user_id` (`user_id`)
- INDEX: `idx_recipe_id` (`recipe_id`)
- INDEX: `idx_is_favorite` (`is_favorite`)

**关联关系**:
- 多对一: `users` (通过 `user_id`)
- 多对一: `recipes` (通过 `recipe_id`)

**重要说明**:
- 此表仅用于系统食谱（`recipes.user_id = NULL`）
- 用户添加系统食谱时创建记录
- `is_favorite` 控制系统食谱的收藏状态
- 唯一索引确保用户不会重复添加同一食谱

---

### 4. fridges（冰箱表）

存储用户冰箱信息（每个用户一个冰箱）。

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 冰箱唯一标识 |
| user_id | INTEGER | NOT NULL, UNIQUE | - | 用户ID（一对一关系） |
| created_at | DATETIME | - | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `user_id`

**关联关系**:
- 一对一: `users` (通过 `user_id`)
- 一对多: `fridge_items` (通过 `fridge_id`)

**重要说明**:
- 用户注册时自动创建冰箱
- 每个用户有且仅有一个冰箱
- 删除用户时级联删除冰箱（CASCADE）

---

### 5. fridge_items（冰箱食材表）

存储冰箱中的食材信息。

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 食材唯一标识 |
| fridge_id | INTEGER | NOT NULL | - | 所属冰箱ID |
| ingredient_name | VARCHAR(50) | NOT NULL | - | 食材名称 |
| quantity | VARCHAR(20) | NULL | - | 数量 |
| category | VARCHAR(20) | NULL | - | 分类（蔬菜/肉类/调料等） |
| unit | VARCHAR(20) | NULL | - | 单位（克/个/ml等） |
| added_at | DATETIME | - | CURRENT_TIMESTAMP | 添加时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `fridge_id`

**关联关系**:
- 多对一: `fridges` (通过 `fridge_id`)

**重要说明**:
- 删除冰箱时级联删除所有食材（CASCADE）
- `ingredient_name` 用于匹配食谱中的食材

---

### 6. shopping_items（采购清单表）

存储用户的采购清单。

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | - | 采购项唯一标识 |
| user_id | INTEGER | NOT NULL | - | 用户ID |
| name | VARCHAR(50) | NOT NULL | - | 食材名称 |
| quantity | VARCHAR(20) | NULL | - | 数量 |
| category | VARCHAR(20) | - | '其他' | 分类 |
| created_at | DATETIME | - | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `user_id`

**关联关系**:
- 多对一: `users` (通过 `user_id`)

**重要说明**:
- 支持"移至冰箱"功能（转移到 `fridge_items`）
- UI入口已移除，但后端API仍可用

---

## 数据关系图

```
users (用户)
  ├─ 1:1 → fridges (冰箱)
  │         └─ 1:N → fridge_items (冰箱食材)
  │
  ├─ 1:N → recipes (个人食谱, user_id != NULL)
  │
  ├─ 1:N → shopping_items (采购清单)
  │
  └─ 1:N → user_recipes (系统食谱关联)
              └─ N:1 → recipes (系统食谱, user_id = NULL)
```

---

## 重要业务逻辑

### 1. 食谱类型区分

**系统食谱** (`recipes.user_id = NULL`):
- 由系统预设，所有用户可见
- 收藏状态存储在 `user_recipes.is_favorite`
- 用户需先"添加"到个人库（创建 `user_recipes` 记录）才能收藏
- API: `/api/user-recipes/favorite`

**个人食谱** (`recipes.user_id != NULL`):
- 由用户创建，仅创建者可见
- 收藏状态存储在 `recipes.is_favorite`
- 可以直接收藏（无需添加）
- API: `/api/recipes/:id/favorite`

### 2. 收藏功能实现

```sql
-- 系统食谱收藏（通过user_recipes表）
INSERT INTO user_recipes (user_id, recipe_id, is_favorite) 
VALUES (1, 63, true)
ON DUPLICATE KEY UPDATE is_favorite = NOT is_favorite;

-- 个人食谱收藏（直接更新recipes表）
UPDATE recipes 
SET is_favorite = NOT is_favorite 
WHERE id = 10 AND user_id = 1;
```

### 3. 推荐算法数据查询

推荐系统需要联合查询：
- 用户冰箱食材 (`fridge_items`)
- 食谱食材 (`recipes.ingredients` JSON字段)
- 匹配度计算：可用食材数 / 总需求食材数

### 4. 级联删除规则

- 删除用户 → 级联删除冰箱 → 级联删除冰箱食材
- 删除用户 → 级联删除个人食谱
- 删除用户 → 级联删除采购清单
- 删除用户 → 级联删除用户-食谱关联

---

## 数据初始化

### 种子数据脚本
- `server/seed_new.js`: 初始化演示数据
  - 创建演示用户（ID=1, phone=13800138000）
  - 创建系统食谱（user_id=NULL）
  - 创建个人食谱示例
  - 初始化冰箱和食材
  - 创建用户-食谱关联

### 运行种子脚本
```bash
cd server
node seed_new.js
```

---

## 性能优化建议

### 已实现的索引
- `users.phone`: 唯一索引（登录查询）
- `recipes.user_id`: 索引（筛选个人/系统食谱）
- `recipes.category`: 索引（分类筛选）
- `recipes.is_favorite`: 索引（收藏筛选）
- `recipes.cooked_count`: 索引（排序）
- `user_recipes.user_id + recipe_id`: 唯一复合索引（防重复）
- `fridge_items.fridge_id`: 索引（查询冰箱食材）
- `shopping_items.user_id`: 索引（查询采购清单）

### 查询优化
- 使用 `sequelize.random()` 进行随机排序
- JSON字段查询使用原生SQL（`JSON_EXTRACT`）
- 分页查询使用 `LIMIT` 和 `OFFSET`
- 关联查询使用 `JOIN` 而非多次查询

---

## 数据库连接配置

配置文件: `server/config/database.js`

```javascript
{
  host: process.env.DB_HOST || 'localhost',
  port: process.env.DB_PORT || 3306,
  database: process.env.DB_NAME || 'recipe_db',
  username: process.env.DB_USER || 'root',
  password: process.env.DB_PASSWORD || '',
  dialect: 'mysql',
  timezone: '+08:00'
}
```

### 环境变量
- `DB_HOST`: 数据库主机
- `DB_PORT`: 数据库端口
- `DB_NAME`: 数据库名称
- `DB_USER`: 数据库用户名
- `DB_PASSWORD`: 数据库密码
- `JWT_SECRET`: JWT密钥（用于token生成）

---

## 数据完整性约束

### 外键约束（通过Sequelize关联实现）
- `fridges.user_id` → `users.id` (CASCADE)
- `fridge_items.fridge_id` → `fridges.id` (CASCADE)
- `recipes.user_id` → `users.id` (允许NULL)
- `shopping_items.user_id` → `users.id`
- `user_recipes.user_id` → `users.id`
- `user_recipes.recipe_id` → `recipes.id`

### 唯一性约束
- `users.phone`: 手机号唯一
- `fridges.user_id`: 每个用户一个冰箱
- `user_recipes(user_id, recipe_id)`: 防止重复添加

### 非空约束
- 所有主键字段
- `users.username`, `users.phone`, `users.password`
- `recipes.name`
- `fridge_items.ingredient_name`
- `shopping_items.name`
- `user_recipes.user_id`, `user_recipes.recipe_id`
